# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/

$ ->
  if $('#car-wash-signal').prop("checked")
    $('img#red-green').attr('src', "<%= asset_path('banner_green_x2.png') %>")
    $('img#green').attr('src', "<%= asset_path('green.png') %>")
    $('img#red').attr('src', "<%= asset_path('red_blur.png') %>")
  else
    $('img#red-green').attr('src', "<%= asset_path('banner_red.png') %>")
    $('img#green').attr('src', "<%= asset_path('green_blur.png') %>")
    $('img#red').attr('src', "<%= asset_path('red.png') %>")

  $(document).on 'click', '#red-green', (e) ->
    e.preventDefault()
    if $('#car-wash-signal').prop("checked")
      $("input[type='checkbox']#car-wash-signal").prop("checked", false)
      $('img#red-green').attr('src', "<%= asset_path('banner_red.png') %>")
    else
      $("input[type='checkbox']#car-wash-signal").prop("checked", true)
      $('img#red-green').attr('src', "<%= asset_path('banner_green_x2.png') %>")

  $(document).on 'click', 'img#green', (e) ->
    e.preventDefault()
    $("input[type='checkbox']#car-wash-signal").prop("checked", true)
    $('img#red-green').attr('src', "<%= asset_path('banner_green_x2.png') %>")
    $('img#green').attr('src', "<%= asset_path('green.png') %>")
    $('img#red').attr('src', "<%= asset_path('red_blur.png') %>")

  $(document).on 'click', 'img#red', (e) ->
    e.preventDefault()
    $("input[type='checkbox']#car-wash-signal").prop("checked", false)
    $('img#red-green').attr('src', "<%= asset_path('banner_red.png') %>")
    $('img#green').attr('src', "<%= asset_path('green_blur.png') %>")
    $('img#red').attr('src', "<%= asset_path('red.png') %>")

@CarWashPoller =
  poll: ->
    setTimeout @request, 5000
  request: ->
    $.ajax
      url: $('#map').data('url')
      dataType: "json"
      data:
        updated_at: $('#map').data('updated-at')
    .done (data) => CarWashPoller.updateMap(data)
  updateMap: (data) ->
    updated_at = data.updated_at
    $('#map').data('updated-at', updated_at)
    car_washes = data.car_washes
    if (car_washes?)
      car_washes.forEach (cw) ->
        if (cw?)
          id = cw.id
          signal = cw.signal
          blink = cw.blink
          searchString = 'properties.car_wash_id = ' + id
          geoQueryResult = myMap.storage.search(searchString)
          geoQueryResult.each (o) ->
            o.getParent().remove(o)
            if signal and blink then greenBlinkCollection.add(o)
            if signal and not blink then greenCollection.add(o)
            if not signal and blink then redBlinkCollection.add(o)
            if not signal and not blink then redCollection.add(o)
    @poll()
jQuery ->
  if $('#map').length > 0
    CarWashPoller.poll()
