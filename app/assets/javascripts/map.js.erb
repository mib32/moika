/* Day Name Strings */
 var  ru_Date = 
  {
    dayNames: ["воскресенье", "понедельник", "вторник", "среда", "четверг", "пятница", "суббота"],
    abbreviatedDayNames: ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"],
    shortestDayNames: ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"],
    firstLetterDayNames: ["В", "П", "В", "С", "Ч", "П", "С"],

    /* Month Name Strings */
    monthNames: ["января", "февраля", "марта", "апреля", "мая", "июня", "июля", "августа", "сентября", "октября", "ноябрь", "декабря"],
    abbreviatedMonthNames: ["янв", "фев", "мар", "апр", "май", "июн", "июл", "авг", "сен", "окт", "ноя", "дек"]
  }

function log (argument) {
  console.log(argument)
}
var myMap,
  cw_list = [],
  geo_objects_ary = [];


$(document).ready( function() {
  log("document ready!");
  function getCarWashes() {
    $.ajax('/car_washes', {
      dataType: "json",
      cache: false,
      success: function(json) {
        cw_list = [];
        json.forEach( function(row) {
          cw_list.push({coords: [row.lat, row.lon], id: row.id, address: row.address, title: row.title, signal: row.signal, url: row.url.slice(0,-5), contacts: row.contacts, services: row.services});
          })
        log("json success done");
        log("load map...");
        ymaps.ready(init);
        log("done load map...");
      }
    })
  };
  getCarWashes();
  log('getCarWashes done');
  //ymaps.ready(init);
});


function init(){
  myMap = new ymaps.Map ("map", {
      center: [55.76, 37.64],
      zoom: 11,
  });

  clusterer = new ymaps.Clusterer({
    preset: 'twirl#invertedVioletClusterIcons',
    groupByCoordinates: false,
    clusterDisableClickZoom: false,
    minClusterSize: 3,
    gridSize: 80
    })

  ymaps.option.presetStorage.add('my#red', {
  iconImageHref: "<%= asset_path('red_led.png') %>"  });
  ymaps.option.presetStorage.add('my#green', {
  iconImageHref: "<%= asset_path('green_bl.gif') %>"  });

  myMap.controls
      // Кнопка изменения масштаба.
      .add('zoomControl', { left: 5, top: 5 })
      // Список типов карты
      .add('typeSelector')
      // Стандартный набор кнопок
      .add('mapTools', { left: 35, top: 5 })
      .add('routeEditor', { left: 130, top: 5 })
      .add(new ymaps.control.TrafficControl({providerKey: 'traffic#actual', shown: true}))
      .add('searchControl', { left: 180, top: 5 });

  myMap.behaviors.enable('scrollZoom');

  var myBalloonContentBodyLayout = ymaps.templateLayoutFactory.createClass(
                  '<div>$[properties.body]</div>'
              );
  console.log(cw_list);

  greenCollection = new ymaps.GeoObjectCollection({}, {
      preset: 'my#green',
      iconImageSize: [20, 20]
  });

  redCollection = new ymaps.GeoObjectCollection({}, {
      preset: 'my#red',
      iconImageSize: [20, 20]
  });

  cw_list.forEach(function (car_wash) {


    var myBalloonBody = (car_wash.signal) ?
      (
      '<h3>'
      + car_wash.title
      + '</h3>'
      + car_wash.address
      + '<br/>'
      + car_wash.contacts
      + '<br/>'
      + car_wash.services
      + '<br/>'
      + 'Пост занят'
      + '<br/>'
      + '<img src="'
      + "<%= asset_path('banner_green.png') %>"
      + '">'
      + '<br/>'
      + '<a href="'
      + car_wash.url
      + '">Перейти на страницу этой мойки</a>'
      ):
      (
      '<h3>'
      + car_wash.title
      + '</h3>'
      + car_wash.address
      + '<br/>'
      + car_wash.contacts
      + '<br/>'
      + car_wash.services
      + '<br/>'
      + 'Пост загружен'
      + '<br/>'
      + '<img src="'
      + "<%= asset_path('banner_red.png') %>"
      + '">'
      + '<br/>'
      + '<a href="'
      + car_wash.url
      + '">Перейти на страницу этой мойки</a>'
      );

      var timeNow = new Date;

      var myHintContent = (car_wash.signal) ?
        (
        '<h3>' + car_wash.title + '</h3>'
        + '<h5>' + car_wash.address + '</h5>'
        + '<h5>Время:' + timeNow.toLocaleTimeString() + '</h5>'
        + '<h5>Пост свободен</h5>'
        + '<img src="'
        + "<%= asset_path('banner_green.png') %>"
        + '">'
        ):
        ('<h3>' + car_wash.title + '</h3>' + '<br/>'
        + '<h5>' + car_wash.address + '</h5>'
        + '<h5>Время:' + timeNow.toLocaleTimeString() + '</h5>'
        + '<h5>Пост загружен</h5>'
        + '<img src="'
        + "<%= asset_path('banner_red.png') %>"
        + '">'
        );

    var coordinates = car_wash.coords,
      properties = {
        body: myBalloonBody,
        hintContent: myHintContent
      },
      options = {
        balloonContentBodyLayout : myBalloonContentBodyLayout,
        preset: (car_wash.signal) ?
          ('my#green'):
          ('my#red'),
        iconImageSize: [20, 20]
      },
      placemark = new ymaps.Placemark(coordinates, properties, options);


    (car_wash.signal) ? ( greenCollection.add(placemark) ):( redCollection.add(placemark) );
    geo_objects_ary.push(placemark)

  });
    myMap.geoObjects.add(greenCollection);
    myMap.geoObjects.add(redCollection);
    //clusterer.add(geo_objects_ary);
    //myMap.geoObjects.add(clusterer);
}

$(document).ready(function() {
  setInterval(function() {
  var date_now = new Date();
  $(".datetime").html(
    ru_Date.abbreviatedDayNames[date_now.getDay()] + 
    ' ' + 
    date_now.getDate() + 
    ' ' + 
    ru_Date.monthNames[date_now.getMonth()] + 
    ' ' + 
    date_now.getFullYear() + 
    ' г. | ' + 
    date_now.toLocaleTimeString() +
    ' | ' 
    );
  },500)
});